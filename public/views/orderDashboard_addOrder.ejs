<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <!-- <link rel="stylesheet" href="../styles/main.css" /> -->
    <link rel="stylesheet" href="../styles/orderDashboard.css" />
    <link rel="shortcut icon" href="../icon.png" type="image/x-icon" />
    <title>Add Order</title>
  </head>

  <body>
    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark py-3">
      <button
        class="navbar-toggler ms-3"
        type="button"
        data-toggle="collapse"
        data-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent"
        aria-expanded="false"
        aria-label="Toggle navigation"
      >
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav mr-auto px-3">
          <li class="nav-item">
            <a href="/orderDashboard" class="nav-link">Orders</a>
          </li>
          <li class="nav-item">
            <a href="/orderDashboard/products" class="nav-link">Products</a>
          </li>
          <li class="nav-item">
            <a href="/orderDashboard/hampers" class="nav-link">Hampers</a>
          </li>
          <li class="nav-item">
            <a href="/orderDashboard/customers" class="nav-link">Customers</a>
          </li>
        </ul>
      </div>
      <button class="btn btn-light mx-3" onclick="redirect('/logout')">
        Logout
      </button>
    </nav>

    <!-- Wrapper -->
    <div class="container mx-auto mt-5 row mb-5 px-0">
      <!-- Form -->
      <form
        action="/orderDashboard/addHamper"
        method="post"
        class="w-lg-50 col"
        style="max-width: 40%"
        id="myForm"
      >
        <h1>‚ûïAdd Orderüßæ</h1>
        <br />

        <!-- Select Option for Customer -->
        <div
          class="btn-group"
          role="group"
          aria-label="Basic radio toggle button group"
          onchange="changeCustomerType()"
        >
          <input
            type="radio"
            class="btn-check"
            name="customerType"
            value="existing"
            id="btnradio1"
            autocomplete="off"
            checked
          />
          <label class="btn btn-outline-primary order-button" for="btnradio1"
            >Existing Customer</label
          >

          <input
            type="radio"
            class="btn-check"
            name="customerType"
            value="new"
            id="btnradio2"
            autocomplete="off"
          />
          <label class="btn btn-outline-primary order-button" for="btnradio2"
            >New Customer</label
          >
        </div>
        <br />
        <br />

        <!-- Existing Customer Selector -->
        <div class="form-group existingCustomerContainer">
          <label for="existingCustomer" class="form-label"
            >Existing Customer</label
          >
          <select
            class="form-select"
            name="existingCustomer"
            id="existingCustomer"
          >
            <option disabled selected>Select existing customer</option>
            <% customers.forEach(customer => { %>
            <option value="<%= customer._id %>"><%= customer.name %></option>
            <% }) %>
          </select>
          <br />
        </div>

        <!-- New Customer Container -->
        <div class="newCustomerContainer" hidden>
          <!-- <hr class="mt-2" /> -->
          <div class="form-group">
            <label for="customerName" class="form-label">Customer Name</label>
            <input
              type="text"
              class="form-control"
              name="customerName"
              id="customerName"
              placeholder="Enter Customer Name"
            />
          </div>
          <br />
          <div class="form-group">
            <label for="customerAddress" class="form-label"
              >Customer Address</label
            >
            <input
              type="text"
              class="form-control"
              name="customerAddress"
              id="customerAddress"
              placeholder="Enter Customer Address"
            />
          </div>
          <br />
          <div class="form-group">
            <label for="customerNote" class="form-label">Customer Note</label>
            <input
              type="text"
              class="form-control"
              name="customerNote"
              id="customerNote"
              placeholder="Enter Customer Note"
            />
          </div>
          <br />
          <!-- <hr class="mt-2" /> -->
        </div>

        <!-- Product Contents -->
        <div class="form-group">
          <label for="contents">Product Contents</label>

          <!-- Selector -->
          <div class="row m-0">
            <div class="col mx-0 px-0 pe-2">
              <select
                name="productContentInput"
                id="productContentInput"
                class="form-select"
                data-placeholder="Choose a product"
                onchange="advanceTab(this)"
              >
                <option disabled selected value="null">Select a product</option>
                <% products.forEach(product => { %>
                <option value="<%= product._id %>"><%= product.name %></option>
                <% }) %>
              </select>
            </div>
            <div class="col-2 col-sm-1 mx-0 px-0">
              <button
                class="btn btn-primary btn-sm form-control specialFocus"
                type="button"
                onclick="addProductToOrder()"
              >
                <i class="fa-solid fa-plus"></i>
              </button>
            </div>
          </div>

          <br />
        </div>

        <!-- Hamper Contents -->
        <div class="form-group">
          <label for="contents">Hamper Contents</label>

          <!-- Selector -->
          <div class="row m-0">
            <div class="col mx-0 px-0 pe-2">
              <select
                name="hamperContentInput"
                id="hamperContentInput"
                class="form-select"
                data-placeholder="Choose a hamper"
                onchange="advanceTab(this)"
              >
                <option disabled selected value="null">Select a hamper</option>
                <% hampers.forEach(hamper => { %>
                <option value="<%= hamper._id %>"><%= hamper.name %></option>
                <% }) %>
              </select>
            </div>
            <div class="col-2 col-sm-1 mx-0 px-0">
              <button
                class="btn btn-primary btn-sm form-control specialFocus"
                type="button"
                onclick="addProductToOrder()"
              >
                <i class="fa-solid fa-plus"></i>
              </button>
            </div>
          </div>

          <br />
        </div>

        <!-- Order Discount -->
        <div class="form-group">
          <label for="orderDiscount" class="form-label">Order Discount</label>
          <input
            type="number"
            class="form-control"
            name="orderDiscount"
            id="orderDiscount"
            placeholder="Enter Order Discount"
          />
        </div>
        <br />

        <!-- Order Note -->
        <div class="form-group">
          <label for="orderNote" class="form-label">Order Note</label>
          <input
            type="text"
            class="form-control"
            name="orderNote"
            id="orderNote"
            placeholder="Enter Order Note"
          />
        </div>

        <br />

        <!-- Submit Buttons -->
        <div class="container w-100 d-flex justify-content-end p-0">
          <button
            type="button"
            class="btn btn-primary form-btn"
            onclick="validateContents()"
          >
            Submit
          </button>
          <button
            type="button"
            class="btn btn-primary form-btn ms-2"
            onclick="redirect('/orderDashboard/products')"
          >
            Cancel
          </button>
        </div>
      </form>

      <!-- Order Display -->
      <div class="container col border-start ms-5 ps-5">
        <h3 class="text-center">Order Contents‚úçÔ∏è</h3>
        <div class="container table-responsive mt-4 px-0">
          <table
            class="table realContents w-100 mx-auto text-center align-middle"
            onchange="updateTable()"
          >
            <thead>
              <tr>
                <th>Item Name</th>
                <th>Price Type</th>
                <th>Quantity</th>
                <th>Subtotal</th>
                <th></th>
              </tr>
            </thead>
            <tbody
              class="realContentsBody align-content-center border-top"
            ></tbody>
          </table>
        </div>
      </div>
    </div>
  </body>

  <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.0/dist/jquery.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.full.min.js"></script>
  <script>
    function redirect(domain) {
      window.location.href = domain;
    }

    function changeCustomerType() {
      let customerType = document.querySelector(
        "input[name='customerType']:checked"
      ).value;
      if (customerType === "new") {
        document
          .querySelector(".newCustomerContainer")
          .removeAttribute("hidden");
        document
          .querySelector(".existingCustomerContainer")
          .setAttribute("hidden", true);
      } else {
        document
          .querySelector(".newCustomerContainer")
          .setAttribute("hidden", true);
        document
          .querySelector(".existingCustomerContainer")
          .removeAttribute("hidden");
      }
    }

    $("#existingCustomer").select2({
      theme: "bootstrap-5",
      width: $(this).data("width")
        ? $(this).data("width")
        : $(this).hasClass("w-100")
        ? "100%"
        : "style",
      placeholder: $(this).data("placeholder"),
    });

    $("#productContentInput").select2({
      theme: "bootstrap-5",
      width: $(this).data("width")
        ? $(this).data("width")
        : $(this).hasClass("w-100")
        ? "100%"
        : "style",
      placeholder: $(this).data("placeholder"),
    });

    $("#hamperContentInput").select2({
      theme: "bootstrap-5",
      width: $(this).data("width")
        ? $(this).data("width")
        : $(this).hasClass("w-100")
        ? "100%"
        : "style",
      placeholder: $(this).data("placeholder"),
    });

    function advanceTab(el) {
      let nextBtn = el.parentElement.parentElement.querySelector(".btn");
      console.log(nextBtn);
      nextBtn.setAttribute("tabIndex", "0");
      setTimeout(function () {
        nextBtn.focus();
      }, 20);
    }

    function addProductToOrder() {
      var selectedProductId = document.getElementById(
        "productContentInput"
      ).value;
      var selectedProductName = document.getElementById("productContentInput")
        .options[document.getElementById("productContentInput").selectedIndex]
        .text;

      if (!selectedProductId || selectedProductId === "null") {
        alert("Please select a product and enter a product.");
        return;
      }

      var realContents = document.querySelector(".realContentsBody");
      var newProductEntry = document.createElement("tr");

      var columns = [
        { content: selectedProductName, classNames: ["col-3"] },
        {
          content: getPriceInput(selectedProductId),
          classNames: ["col-3"],
        },
        {
          content:
            '<input type="number" class="form-control text-center w-75 mx-auto" name="quantities[]" value="1">',
          classNames: ["col-2", "text-center", "px-4"],
        },
        { content: "", classNames: ["col"] },
        {
          content:
            '<button class="btn btn-danger btn-sm" type="button" onclick="removeThisProduct(this)"><i class="fa-solid fa-trash"></i></button><input type="hidden" name="contents[]" value="' +
            selectedProductId +
            '">',
          classNames: ["col-1", "text-center"],
        },
      ];

      columns.forEach((column) => {
        var td = document.createElement("td");
        td.innerHTML = column.content;
        column.classNames.forEach((className) => td.classList.add(className));
        newProductEntry.appendChild(td);
      });

      realContents.appendChild(newProductEntry);
      document.querySelector(`option[value="${selectedProductId}"]`).remove();
      document.getElementById("productContentInput").value = "null";
      updateTable();
    }

    function getPriceInput(productId) {
      let products = <%- JSON.stringify(products) %> ;
    }

    function removeThisProduct(el) {
      trElement = el.parentElement.parentElement;
      productId = el.nextElementSibling.nextElementSibling.value;
      console.log(el.nextElementSibling.nextElementSibling.value);
      productName = trElement.querySelector(".col-6").innerHTML;

      newOption = document.createElement("option");
      newOption.value = productId;
      newOption.text = productName;

      selectElement = document.getElementById("contentInput");
      selectElement.add(newOption);

      var options = Array.from(selectElement.options);
      options.sort(function (a, b) {
        return a.text.localeCompare(b.text);
      });

      selectElement.innerHTML = "";
      options.forEach(function (option) {
        selectElement.add(option);
      });
      productId = trElement.remove();
    }

    function updateTable() {
      console.log("table");
    }

    function validateContents() {
      let contents = document.querySelector(".realContentsBody");
      if (!document.querySelector("#myForm").reportValidity()) {
        return;
      }
      if (contents.children.length) {
        document.querySelector("form").submit();
      } else {
        alert("Contents must have at least one product!");
      }
    }
  </script>
</html>
